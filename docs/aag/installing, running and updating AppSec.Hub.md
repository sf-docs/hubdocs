# Установка, запуск и обновление AppSec.Hub

## Требования к инфраструктуре

Установленные для эксплуатации AppSec.Hub технические средства должны быть совместимы между собой и поддерживать сетевой протокол TCP/IP.

Для работы программы в качестве сервера используется компьютер с операционной системой:

* Ubuntu Server 18.04.6 x64.
* Linux CentOS 7 и выше.
* Linux RHEL 7 и выше.

Рекомендуемые технические характеристики серверного оборудования:

* Процессор: 4×CPU 2 ГГц.
* Оперативная память: 16 Гб.
* Свободное дисковое пространство: 150 Гб для размещения прикладных систем и баз данных AppSec.Hub.

ПО поддерживает следующие типы ОС и ПО для полноценного функционирования.

<figure markdown>
Операционная система|Архитектура|Платформа
-|-|-
Linux|64-bit|Ubuntu Server 18.04.6 x64
Linux|64-bit|Centos/RHEL 7 и выше
</figure>

## Процесс установки

### Проверка инфраструктуры

Дополнительные пакеты, которые необходимо установить на сервере AppSec.Hub перед началом инсталляции AppSec.Hub:

* Docker версии 19.03.3 и выше.
* Docker-compose версии 1.29.2 и выше.

Проверить версию установленных пакетов Docker и Docker-compose можно с помощью команд:

    docker --version
    docker-compose ––version

### Установка AppSec.Hub

Программа AppSec.Hub разворачивается в инфраструктуре с использованием контейнеров Docker.

Настройте соединение с репозиторием, в котором выложен дистрибутив AppSec.Hub:

    docker login docker.yourcompany.ru

Скачайте инсталляционный образ:

    docker pull docker.yourcompany.ru/hub-installer:<version>
    
Запустите инсталляцию командой:

    docker container run \
        -v /hub/install/path:/opt/apphub \
        -v /root/.docker/config.json:/root/.docker/config.json \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -e REPAIR_DB_ENABLE="disable" \
        -e REPAIR_DW_ENABLE="disable" \
        --rm \
        --name hub-updater \
        -ti \
        docker.yourcompany.ru/hub-installer:<version>

где:

* `/hub/install/path` — папка, куда будут скопированы конфигурационные файлы, этот параметр можно поменять, в этом случае мы рекомендуем указать директорий `/opt/apphub`. При совпадении имен файлов содержимое папки будет очищено. В этой же папке будет по умолчанию расположена папка с БД. В процессе установки автоматически заполняются конфигурационные параметры в ***.env*** файле, описанные в разделе «[Приложение 1. Конфигурационный файл .env](./appendix%201.md)», и конфигурационные параметры в ***app.properties*** файле, описанные в разделе «[Приложение 4. Конфигурационный файл app.properties](../ug/appendix%205.md)»;
* `-v ~/.docker/config.json` — путь к файлу, куда записываются данные после docker login;
* `-e REPAIR_DB_ENABLE="disable"` — режим восстановления hub-db; 
* `-e REPAIR_DW_ENABLE="disable"` — режим восстановления hub-dw;
* `version` — версия релиза, который необходимо установить;
* в файлах ***.env*** и ***app.properties*** будут сгенерированы пароли и ключи;
* в процессе инсталляции будет предложено ввести URL или IP адрес вашего сервера, по которому будет доступен веб интерфейс AppSec.Hub. Это значение в дальнейшем будет использоваться для интеграции с другими инструментами, такими как Jenkins, TeamCity и т. д.;
* в процессе инсталляции так же будет предложено внести в базу данных системы демо-данные.

## Запуск AppSec.Hub

В папке `/hub/install/path` выполните команды:

    docker-compose up -d

После выполнения этой команды подождите примерно 2–3 минуты. AppSec.Hub будет доступен через веб-интерфейс по указанному вами URL или IP адресу сервера.

## Остановка AppSec.Hub

В папке `/hub/install/path` выполните команду:

    docker-compose down

## Обновление системы

1. Остановите AppSec.Hub, см. раздел «[Остановка AppSec.Hub](../installing%2C%20running%20and%20updating%20AppSec.Hub/#appsechub_3)».
2. Укажите новые версии образов в .env файле.
3. Загрузите новые версии контейнеров. Для этого в папке, указанной при установке (см. раздел «[Установка AppSec.Hub](../installing%2C%20running%20and%20updating%20AppSec.Hub/#appsechub_1)», по умолчанию `/opt/apphub`) выполните команду:
    
        docker-compose pull

4. После загрузки образов запустите систему, см. раздел «Запуск AppSec.Hub».

Также возможно обновление системы путем выполнения следующей команды:

    docker container run \
        -v /hub/install/path:/opt/apphub \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -e REPAIR_DB_ENABLE="disable" \
        -e REPAIR_DW_ENABLE="disable" \
        --rm \
        --name hub-updater \
        -ti \
        docker.yourcompany.ru/hub-installer:<version>

## Резервное копирование

Для резервного копирования необходимо:

* Остановить AppSec.Hub, см. раздел «[Остановка AppSec.Hub](../installing%2C%20running%20and%20updating%20AppSec.Hub/#appsechub_3)».
* Сделать резервную копию директории установки AppSec.Hub (по умолчанию, `/opt/apphub`).
* Выполнить резервное копирование директорий, относящихся к docker volumes, но расположенных за пределами директории установки.
* Запустить AppSec.Hub, см. раздел «[Запуск AppSec.Hub](../installing%2C%20running%20and%20updating%20AppSec.Hub/#appsechub_2)».

## Восстановление из резервной копии

Для восстановления необходимо проделать следующие шаги:

* Если на сервере ранее был установлен AppSec.Hub:
    1. Остановить AppSec.Hub, см. раздел «[Остановка AppSec.Hub](../installing%2C%20running%20and%20updating%20AppSec.Hub/#appsechub_3)».
    2. Переместить или переименовать директорию установки AppSec.Hub (по умолчанию, `/opt/apphub`).
    3. Переместить или переименовать директории, относящиеся к docker volumes, но расположенные за пределами директории установки (если такие имеются).
    4. Восстановить из резервной копии установочную директорию AppSec.Hub (по умолчанию, `/opt/apphub`).
    5. Восстановить из резервной копии директории, относящиеся к docker volumes, но расположенные за пределами директории установки.
    6. Запустить AppSec.Hub, см. раздел «[Запуск AppSec.Hub](../installing%2C%20running%20and%20updating%20AppSec.Hub/#appsechub_2)».
* Если на сервере ранее не был установлен AppSec.Hub
    1. Восстановить из резервной копии установочную директорию AppSec.Hub (по умолчанию, `/opt/apphub`).
    2. Восстановить из резервной копии директории, относящиеся к docker volumes, но расположенные за пределами директории установки (если такие имеются).
    3. Запустить AppSec.Hub, см. раздел «[Запуск AppSec.Hub](../installing%2C%20running%20and%20updating%20AppSec.Hub/#appsechub_2)».

Выполните базовый тест восстановленной установки:

* Авторизация.
* Просмотр списка инструментов, проверка соединения с ними (Test connection).
* Просмотр списка приложений.
* Просмотр результатов сканирования (Issues) и дефектов ИБ (Defects).
* Выборочный запуск DevSecOps пайплайнов.
* Просмотр результатов нового сканирования.

## Настройка антивирусной защиты
На сервере с установленным AppSec.Hub необходимо установить антивирусное программное обеспечение в соответствии с политиками компании в области антивирусной защиты.